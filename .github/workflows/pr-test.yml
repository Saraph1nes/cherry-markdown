name: PR Test

on:
  pull_request_target:
    branches: [main, dev]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      BASE_SHA: ${{ github.event.pull_request.base.sha }}
      HEAD_SHA: ${{ github.event.pull_request.head.sha }}

    steps:
      - uses: actions/checkout@v2
        with:
          ref: '${{ env.HEAD_SHA }}'

      - name: Get changed files and operations
        run: |
          # 使用 GitHub API 获取变更文件列表及其操作
          DIFF_FILES=$(gh api repos/${{ github.repository }}/compare/${{ env.BASE_SHA }}...${{ env.HEAD_SHA }} \
            --jq '.files | map({filename, status}) | @json')
          echo "Changed files and operations: ${DIFF_FILES}"

          # 将结果存储在环境变量中
          echo "DIFF_FILES=${DIFF_FILES}" >> $GITHUB_ENV
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - uses: actions/checkout@v2
        if: ${{ env.DIFF_FILES }}
        with:
          repository: ${{ github.repository }}
          ref: '${{ env.BASE_SHA }}'
          path: base-repo

      - name: Replace changed files
        if: ${{ env.DIFF_FILES }}
        run: |
          DIFF_FILES=${{ env.DIFF_FILES }}
          for file_info in $(echo "${DIFF_FILES}" | jq -c '.'); do
            filename=$(echo "${file_info}" | jq -r '.filename')
            status=$(echo "${file_info}" | jq -r '.status')
            if [ "$status" = "modified" ] || [ "$status" = "added" ]; then
              cp "base-repo/$filename" "$filename"
            elif [ "$status" = "removed" ]; then
              rm -f "$filename"
            fi
          done

      - name: Use Node.js 16.x
        uses: actions/setup-node@v2
        with:
          node-version: 16.x
          cache: 'yarn'

      - name: Install dependencies
        uses: borales/actions-yarn@v3.0.0
        with:
          cmd: install

      - name: Eslint
        if: ${{ env.DIFF_FILES }}
        run: |
          DIFF_FILES=${{ env.DIFF_FILES }}
          for file_info in $(echo "${DIFF_FILES}" | jq -c '.'); do
            filename=$(echo "${file_info}" | jq -r '.filename')
            yarn eslint "$filename"
          done

      - name: Run Build
        uses: borales/actions-yarn@v3.0.0
        with:
          cmd: build

      - name: Archive build dist
        uses: actions/upload-artifact@v4
        with:
          name: build-dist
          path: dist

      - name: Archive examples
        uses: actions/upload-artifact@v4
        with:
          name: build-examples
          path: examples

  review:
    needs: build
    permissions: write-all
    uses: ./.github/workflows/pr-reviewer.yml
    secrets: inherit
